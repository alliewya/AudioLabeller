{% extends 'base.html' %} {% block title %}Utilities{% endblock %}

<!---->

{% block content%} {% if user.id == 1 %}

<div class="Row">
  <div class="col-12">
    <div class="d-flex justify-content-center align-items-center p-3">
      <div>
        <h2>Utilities</h2>
      </div>
    </div>
  </div>
</div>

<div class="Row">
  <div class="col-12">
    <div class="d-flex justify-content-center align-items-center p-3">
      <div>
        <h3>Generate Model Predictions</h3>
        <p>Create predictions for all audio files using the stored model</p>
        <button
          type="button"
          class="btn btn-primary text-center pd-3"
          id="btn-pred"
        >
          Go!
        </button>
        <div class="progress mt-3">
          <div
            class="progress-bar"
            id="modelpred-bar"
            role="progressbar"
            style="width: 0%"
            aria-valuenow="0"
            aria-valuemin="0"
            aria-valuemax="100"
          >
            0%
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  var xhrPMP = new XMLHttpRequest();
  function postModelPrediction() {
    xhrPMP.open("POST", "api/runpredictions");
    xhrPMP.setRequestHeader("Content-Type", "application/json");
    xhrPMP.send(JSON.stringify({ data: "Go" }));

    var xhrProgress;
    var intervalID;

    progressbar = document.getElementById("modelpred-bar");

    function start() {
      progressbar.setAttribute("aria-valuenow", 0);
      progressbar.setAttribute("width", 0);
      intervalID = setInterval(function () {
        xhrProgress = new XMLHttpRequest();
        xhrProgress.open("GET", "api/taskprogress", true);
        xhrProgress.setRequestHeader("Content-Type", "application/json");
        xhrProgress.onload = function () {
          if (xhrProgress.status === 200) {
            let response = JSON.parse(xhrProgress.responseText);
            progressbar.setAttribute("aria-valuenow", response.progress);
            progressbar.style.width = response.progress + "%";
            progressbar.innerText = Math.round(response.progress) + "%";
            if (response.progress == 100) {
              stop();
            }
          } else {
            console.error(xhrProgress.statusText);
          }
        };
        xhrProgress.send(JSON.stringify({ processname: "PredictDataset" }));
      }, 500);
    }

    function stop() {
      clearInterval(intervalID);
    }

    //Delay start to allow initial setting of progress to 0
    setTimeout(start(), 700);

  }
  document
    .getElementById("btn-pred")
    .addEventListener("click", postModelPrediction);
</script>

{% else %} .
<div class="Row">
  <div class="col-12">
    <div class="d-flex justify-content-center align-items-center p-3">
      <div>
        <h2><a href="/accounts/login">Access Denied</a></h2>
      </div>
    </div>
  </div>
</div>

{% endif %} {% endblock %}
